<html>
<body>
<style>
    body, html, video
    {
        margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden;
    }
canvas, iframe {
    margin-left: 0px;
    margin-top: 0px;
    position: absolute;
}
#video_elem {
    position: absolute;
    z-index: 2;
    top: 0px;
    left: 0px;
    width: 300px;
    height: 300px;
    border: 0px;
    transform-origin: 0 0;
    -webkit-transform-origin: 0 0;
    -moz-transform-origin: 0 0;
    -o-transform-origin: 0 0;
    visibility: hidden;
}
</style>

<iframe id='video_elem' src="https://player.vimeo.com/video/253989945?color=ef0800&title=0&byline=0&portrait=0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe>

<script async src="js_3rdparty/artoolkit.debug.js"></script>
<script src="js_3rdparty/artoolkit.api.js"></script>
<script src="js_3rdparty/stats.min.js"></script>

<script src="js/pinnedCorners.js"></script>

<script>

var stats = new Stats();
stats.showPanel( 1 ); // 0: fps, 1: ms, 2: mb, 3+: custom
document.body.appendChild( stats.dom );

var videoContentElement = document.getElementById('video_elem');

var video = document.createElement('video');
video.playsInline = true;
video.autoplay = true;

document.body.appendChild(video);

navigator.getUserMedia  = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;

var tw = 1280 / 2;
var th = 720 / 2;

var hdConstraints = {
    audio: false,
    video: {
        facingMode: 'environment',
        width: window.screen.width,
        height: window.screen.height,
    }
};

if (navigator.getUserMedia) {
    navigator.getUserMedia(hdConstraints, success, errorCallback);
} else {
    errorCallback('');
}

function errorCallback(e) {
    console.log("Can't access user media", e);
}


function success(stream) {
    console.log('success', stream);
    video.srcObject = stream;
    video.onclick = function() { video.play(); };
    video.play();

    var cameraParam = new ARCameraParam('data/camera_para.dat');
    cameraParam.onload = function() {

        var arController;

        var interval = setInterval(function() {
            if (!video.videoWidth)	return;

            stats.begin();

            if (!arController) {
                arController = new ARController(video, cameraParam);

                arController.loadMarker('data/patt.spy', function(markerId) {
                    console.log('Marker added: ' + markerId);
                });
            }

            arController.detectMarker();
            marker = arController.getMarker(0);

            if ((marker !== undefined) && (marker.id !== -1)) {
                // console.log(marker);

                const order = [0, 1, 3, 2];  // top-left, top-right, bottom-left, bottom-right
                var rotatedOrder = [];
                for (var i = 0; i < 4; ++i) {
                    rotatedOrder.push( (order[i] + 4 - marker.dirPatt) % 4 );
                }

                pinCornersScaled(
                    videoContentElement,
                    marker.vertex[rotatedOrder[0]][0], marker.vertex[rotatedOrder[0]][1],
                    marker.vertex[rotatedOrder[1]][0], marker.vertex[rotatedOrder[1]][1],
                    marker.vertex[rotatedOrder[2]][0], marker.vertex[rotatedOrder[2]][1],
                    marker.vertex[rotatedOrder[3]][0], marker.vertex[rotatedOrder[3]][1],
                    2);
                videoContentElement.style.visibility = "visible";
            } else {
                videoContentElement.style.visibility = "hidden";
            }

            stats.end();
        }, 30);

    };
}
</script>

</body>
</html>
